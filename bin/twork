#!/bin/sh
. $HOME/.nvm/nvm.sh
backend="$HOME/Work/backend"
front="$HOME/Work/platform"

case $1 in
infra)
	tmux new-session -d -s infra
	tmux split-window -h -t infra:0.0
	tmux send-keys -t infra:0.0 "sudo -E kubefwd svc -d `kubectl config current-context`" C-m
	tmux send-keys -t infra:0.1 "watch -n 0.1 'kubectl get pod | rg -v kibana | rg -v node-exporter | rg -v nvidia'" C-m
	tmux attach-session -t infra:0.0
	;;

front)
	tmux new-session -d -s front
	nvm use 18
	tmux split-window -t front:0.0 # 0 1
	tmux send-keys -t front:0.0 "cd $backend && make build pkg=backoffice-app && make serve env=local pkg=backoffice-app" C-m
	tmux send-keys -t front:0.1 "cd $front && yarn && yarn build && yarn dev" C-m
	tmux attach-session -t front:0.0
	;;

back)
	tmux new-session -d -s back
	tmux split-window -t back:0.0 # 0 1

	tmux split-window -t back:0.0 # 0 1 - 2
	tmux split-window -t back:0.2 # 0 1 2 3

	tmux split-window -t back:0.0 # 0 1 - 2 3 4
	tmux split-window -t back:0.2 # 0 1 2 3 - 4 5
	tmux split-window -t back:0.4 # 0 1 2 3 4 5 - 6
	# tmux split-window -t back:0.6 # 0 1 2 3 4 5 6 7

	tmux send-keys -t back:0.0 "make build pkg=font-api && source $backend/bin/font-api.env && bin/font-api" C-m
	tmux send-keys -t back:0.1 "make build pkg=notification-api && source $backend/bin/notification-api.env && bin/notification-api" C-m
	tmux send-keys -t back:0.2 "make build pkg=payment-api && source $backend/bin/payment-api.env && bin/payment-api" C-m
	tmux send-keys -t back:0.3 "make build pkg=suggestion-api && source $backend/bin/suggestion-api.env && bin/suggestion-api" C-m
	tmux send-keys -t back:0.4 "make build pkg=video-api && source $backend/bin/video-api.env && bin/video-api" C-m
	tmux send-keys -t back:0.5 "make build pkg=workspace-api && source $backend/bin/workspace-api.env && bin/workspace-api" C-m

	nvm use 18
	tmux send-keys -t back:0.6 "make buildx pkg=graphql-api && source $backend/bin/graphql-api.env && node bin/graphql-api" C-m
	tmux attach-session -t back:0.0
	;;
esac
